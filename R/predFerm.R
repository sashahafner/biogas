# Fermentation

source('readFormula.R')
form = 'C6H10O5'
predFerm('C6H10O5', acefrac = 0)
predFerm('C6H10O5', acefrac = 0.5)
predFerm('C6H10O5', acefrac = 1)
predFerm('C6H10O5', acefrac = 1)

# Function to get stoichiometry for custom organic reaction (O-19)
customOrgStoich <- function(form, elements =  c('C', 'H', 'O', 'N')) {
  
  fc <- readFormula(form, elements)

  # Use symbols from O-19 in R&M
  n <- as.numeric(fc['C'])
  a <- as.numeric(fc['H'])
  b <- as.numeric(fc['O'])
  cc <- as.numeric(fc['N'])
  d <- 4 * n + a - 2 * b - 3 * cc
  
  # Put together
  rr <- c(CO2 = - (n - cc) / d, NH4. = - cc / d, HCO3. = - cc / d)
  rr[form] <-  1/d
  
  return(rr)
  
}

predFerm <- function(
  subform = NULL,           # Character chemical formula of substrate
  biomassform = 'C5H7O2N',  # Biomass empirical formula
  acefrac = 0.5,            # Acetate (vs. H2) fraction
  fs = 0                    # Fraction substrate going to cell synthesis, fs in Rittmann and McCarty
  ) {

  # Donor half reaction
  rd <- customOrgStoich(subform, elements = c('C', 'H', 'O', 'N'))

  # Synthesis half reaction
  rs <- customOrgStoich(biomassform, elements = c('C', 'H', 'O', 'N'))

  # Acceptor reactions
  # Acetate production
  raa <- c(CO2 = - 1/8, HCO3. = - 1/8, CH3COO. = 1/8, H2O = 3/8)
  # Hydrogen production
  rah <- c(H. = - 1, H2 = 1 / 2)

  ii <- unique(names(c(rd, rs, raa, rah)))

  # Blanks
  rd[ii[!ii %in% names(rd)]] <- 0
  raa[ii[!ii %in% names(raa)]] <- 0
  rah[ii[!ii %in% names(rah)]] <- 0

  # Order
  rd <- rd[ii]
  rs <- rs[ii]
  raa <- raa[ii]
  rah <- rah[ii]

  # Combine
  rtot <- (1 - fs) * (acefrac * raa + (1 - acefrac) * rah - rd) - fs * rs

  return(rtot)

}
